---
  name: Publish Snapshot

  on:
    schedule:
      # Runs against the default branch every day overnight
      - cron: "18 3 * * *"
    workflow_dispatch:

  jobs:
    # changes-since-last:
    #   runs-on: ubuntu-latest
    #   steps:
    #     - name: Get Git SHA
    #       id: gitsha
    #       run: echo "::set-output name=gitsha::$(git rev-parse HEAD)"

    tests:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Tests
          uses: ./.github/actions/tests

    lint:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Lint
          uses: ./.github/actions/lint

    release-image:
      runs-on: ubuntu-latest
      needs:
        - tests
        - lint
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Build
          uses: ./.github/actions/docker-image
          with:
            token: ${{ secrets.GITHUB_TOKEN }}

    release-binaries:
      runs-on: ubuntu-latest
      needs: tests
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Generate Token
          uses: actions/create-github-app-token@v1
          id: generate-token
          with:
            app-id: "${{ secrets.APP_ID }}"
            private-key: "${{ secrets.APP_PRIVATE_KEY }}"

        - name: Release
          uses: ./.github/actions/go-release
          with:
            token: "${{ steps.generate-token.outputs.token }}"
