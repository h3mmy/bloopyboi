---
name: Schedule Snapshot

on:
  schedule:
    # Runs against the default branch every day overnight
    - cron: "18 3 * * *"
  workflow_dispatch:
    inputs:
      dryRun:
        description: "Dry-Run"
        default: false
        required: false
        type: boolean

env:
  DEFAULT_BRANCH: dev

jobs:
  changes-since-last:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.should-run.outputs.run }}
      latest-sha: ${{ steps.gitsha.outputs.latestsha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}

      - name: Get Git SHA
        id: gitsha
        run: |
          echo "latestsha=gitsha::$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "Collected latest gitsha::$(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY

      - name: Generate Token
        uses: actions/create-github-app-token@v1
        id: generate-token
        with:
          app-id: "${{ secrets.APP_ID }}"
          private-key: "${{ secrets.APP_PRIVATE_KEY }}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ steps.generate-token.outputs.token }}

      - name: Pull info from registry
        run: |
          docker inspect ghcr.io/${{ github.repository }}:${{ env.DEFAULT_BRANCH }}

      - name: assume-testing
        id: should-run
        run: echo "run=${{ !inputs.dryRun }}" >> $GITHUB_OUTPUT

  run-publish-snapshot:
    needs:
      - changes-since-last
    if: needs.changes-since-last.outputs.should-run == true
    uses: ./.github/workflows/publish-snapshot.yaml
    secrets: inherit
